<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nonton Drama</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
      const IS_LITE =
        (navigator.deviceMemory && navigator.deviceMemory <= 3) ||
        /Android [5-8]/i.test(navigator.userAgent) ||
        window.innerWidth <= 360;

      if (IS_LITE) {
        document.documentElement.classList.add("lite");
      }
    </script>
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --bg: #0f172a;
            --card-bg: #1e293b;
            --surface: #334155;
            --text: #f1f5f9;
            --text-secondary: #94a3b8;
            --radius: 12px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.5;
            min-height: 100vh;
            padding-bottom: env(safe-area-inset-bottom);
        }

        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            padding: 16px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow);
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 700;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .search-container {
            padding: 16px;
            background: var(--bg);
        }

        .search-box {
            display: flex;
            gap: 8px;
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 8px 12px;
            box-shadow: var(--shadow);
        }

        .search-box input {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--text);
            font-size: 1rem;
            padding: 8px;
            outline: none;
        }

        .search-box input::placeholder {
            color: var(--text-secondary);
        }

        .search-btn {
            background: var(--primary);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.2s;
        }

        .search-btn:active {
            background: var(--primary-dark);
            transform: scale(0.95);
        }

        .categories {
            padding: 0 16px 16px;
            display: flex;
            gap: 10px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }

        .categories::-webkit-scrollbar {
            display: none;
        }

        .category-btn {
            background: var(--card-bg);
            border: none;
            color: var(--text-secondary);
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 0.9rem;
            white-space: nowrap;
            cursor: pointer;
            transition: transform 0.15s, background 0.15s;
            flex-shrink: 0;
        }

        .category-btn.active {
            background: var(--primary);
            color: white;
        }

        .content {
            padding: 0 16px 80px;
            min-height: 60vh;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 16px;
            padding-bottom: 16px;
        }

        .card {
            background: var(--card-bg);
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: var(--shadow);
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
            aspect-ratio: 2/3;
            position: relative;
        }

        .card:active {
            transform: scale(0.98);
        }

        .card-img {
            width: 100%;
            height: 70%;
            background: linear-gradient(45deg, #4f46e5, #7c3aed);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            color: rgba(255, 255, 255, 0.9);
            background-size: cover;
            background-position: center;
            position: relative;
            z-index: 1;
        }

        .card-img img {
          width: 100%;
          height: 100%;
          object-fit: cover;
          display: block;
        }

        .card,
        .episode-item {
          contain: layout paint;
        }

        .card-info {
            padding: 12px;
            height: 30%;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .card-title {
            font-size: 0.9rem;
            font-weight: 600;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            margin-bottom: 4px;
        }

        .card-title em {
          color: #facc15;
          font-style: normal;
        }

        .card-meta {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .card,
        .card-img,
        .episode-item {
          will-change: transform;
          transform: translateZ(0);
        }

        body.scrolling .card,
        body.scrolling .search-box,
        body.scrolling .episode-item {
          box-shadow: none !important;
        }

        .episode-list {
            padding: 0;
        }

        .episode-item {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 14px 16px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: background 0.2s, transform 0.15s;
            border-left: 4px solid transparent;
            position: relative;
            overflow: hidden;
            display: flex;
        }

        .episode-item:active {
            background: var(--surface);
            transform: scale(0.98);
        }

        .episode-item.playing {
            border-left-color: var(--primary);
            background: linear-gradient(to right, rgba(99, 102, 241, 0.1), transparent);
        }

        .episode-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .episode-number {
            font-weight: 700;
            color: white;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .episode-number .ep-badge {
            background: var(--primary);
            color: white;
            font-size: 0.7rem;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: 600;
        }

        .episode-meta {
            display: flex;
            gap: 12px;
            font-size: 0.8rem;
            color: var(--text-secondary);
            align-items: center;
            flex-wrap: wrap;
        }

        .episode-duration {
            display: flex;
            align-items: center;
            gap: 4px;
            background: rgba(99, 102, 241, 0.1);
            padding: 3px 8px;
            border-radius: 12px;
            color: var(--primary);
            font-weight: 500;
        }

        .episode-duration i {
            font-size: 0.7rem;
        }

        .episode-play {
            color: var(--primary);
            font-size: 1.5rem;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: rgba(99, 102, 241, 0.1);
            transition: transform 0.2s, background 0.2s;
            align-self: center;
        }

        .episode-item.playing .episode-play {
            background: var(--primary);
            color: white;
        }

        .episode-play:active {
            transform: scale(0.9);
        }

        .video-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: black;
            z-index: 1000;
            display: none;
        }

        .video-player {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .video-controls {
            position: absolute;
            top: 12px;
            left: 12px;
            right: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .video-controls button {
            pointer-events: auto;
        }

        .back-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 44px;
            height: 44px;
            font-size: 1.2rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            backdrop-filter: blur(10px);
        }

        .episode-display {
            position: absolute;
            left: 70px;
            right: 100px;
            pointer-events: none;
            z-index: 1;
            max-width: 70%;
            align-self: end;
        }

        .episode-display-content {
            color: white;
            padding: 8px 14px;
            border-radius: 10px;
            font-size: 0.85rem;
            backdrop-filter: blur(8px);
            display: inline-block;
            max-width: 100%;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }

        .episode-display-content strong {
            color: #facc15;
            margin-right: 6px;
        }

        .loading {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--surface);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-icon {
            font-size: 3rem;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--card-bg);
            display: flex;
            padding: 12px 16px;
            gap: 16px;
            border-top: 1px solid var(--surface);
            z-index: 100;
        }

        .nav-btn {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px 0;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.15s, background 0.15s;
            font-size: 0.8rem;
        }

        .nav-btn.active {
            color: var(--primary);
            background: rgba(99, 102, 241, 0.1);
        }

        .nav-btn i {
            font-size: 1.2rem;
        }

        .global-watermark {
            position: fixed;
            bottom: 80px;
            right: 12px;
            z-index: 50;
            font-size: 0.65rem;
            opacity: 0.4;
            pointer-events: none;
        }

        .detail-title {
            font-size: clamp(1.1rem, 4.5vw, 1.4rem);
            font-weight: 700;
            margin-bottom: 16px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .resolution-select {
          pointer-events: auto;
          background: rgba(0,0,0,0.55);
          color: white;
          border: none;
          padding: 6px 10px;
          border-radius: 8px;
          font-size: 0.8rem;
          outline: none;
          backdrop-filter: blur(8px);
        }

        .badges {
          position: absolute;
          top: 8px;
          left: 8px;
          display: flex;
          flex-wrap: wrap;
          gap: 6px;
          z-index: 5;
        }

        .badge {
          font-size: 0.65rem;
          font-weight: 700;
          padding: 4px 8px;
          border-radius: 999px;
          color: white;
          backdrop-filter: blur(6px);
          box-shadow: 0 2px 6px rgba(0,0,0,0.4);
        }

        .badge.hot { background: #ef4444; }
        .badge.new { background: #22c55e; }
        .badge.exclusive { background: #facc15; color: #1e293b; }
        .badge.dub { background: #3b82f6; }
        .badge.original { background: #8b5cf6; }
        .badge.saved { background: #64748b; }

        .app-title {
          font-size: 1.6rem;
          font-weight: 800;
          display: flex;
          align-items: center;
          gap: 10px;
        }

        .load-more {
            text-align: center;
            padding: 20px;
            margin: 10px 0;
        }

        .load-more-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: var(--radius);
            font-size: 0.9rem;
            cursor: pointer;
            transition: background 0.2s;
        }

        .load-more-btn:active {
            background: var(--primary-dark);
        }

        .load-more-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .infinite-loading {
            padding: 20px;
            text-align: center;
            color: var(--text-secondary);
        }

        @media (max-width: 768px) {
          .badge,
          .back-btn,
          .resolution-select,
          .episode-display-content {
            backdrop-filter: none;
          }
          
          .episode-display {
            left: 70px;
            right: 90px;
            max-width: 65%;
          }
          
          .episode-display-content {
            padding: 6px 10px;
            font-size: 0.8rem;
          }
          
          .episode-meta {
            font-size: 0.75rem;
          }
        }

        @media (max-width: 480px) {
            .grid {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
                gap: 12px;
            }
            
            .card-title {
                font-size: 0.85rem;
            }
            
            .episode-display {
                left: 60px;
                right: 80px;
                max-width: 60%;
            }
            
            .episode-display-content {
                padding: 5px 8px;
                font-size: 0.75rem;
            }
            
            .episode-item {
                padding: 12px 14px;
            }
            
            .episode-play {
                width: 40px;
                height: 40px;
                font-size: 1.2rem;
            }
        }

        @media (max-width: 360px) {
            .grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }
        }

        .lite * {
          animation: none !important;
          transition: none !important;
        }

        .lite .card,
        .lite .search-box,
        .lite .episode-item,
        .lite .header,
        .lite .bottom-nav {
          box-shadow: none !important;
        }

        .lite .badge,
        .lite .back-btn,
        .lite .resolution-select,
        .lite .episode-display-content {
          backdrop-filter: none !important;
        }

        .lite .episode-display-content {
            background: rgba(0, 0, 0, 0.8);
        }

        .lite .grid {
          display: flex;
          flex-direction: column;
          gap: 10px;
        }

        .lite .card {
          display: flex;
          height: 100px;
          aspect-ratio: auto;
        }

        .lite .card-img {
          width: 70px;
          height: 100%;
          flex-shrink: 0;
        }

        .lite .card-info {
          height: auto;
          padding: 8px;
          flex: 1;
          display: flex;
          flex-direction: column;
          justify-content: center;
        }

        .lite .badges {
          top: 0px;
          left: auto;
          right: 0px;
          display: flex;
          position: absolute;
        }

        .lite .card-title {
          font-size: 0.9rem;
        }

        .lite .video-controls {
          opacity: 1 !important;
          transition: none !important;
        }

        .lite .global-watermark {
          display: none;
        }
        
        .lite .back-btn,
        .lite .resolution-select {
          background: rgba(0,0,0,0.7) !important;
        }

        .lite .episode-item {
            display: flex;
            flex-direction: row;
            align-items: center;
            padding: 10px 12px;
        }

        .lite .episode-play {
            background: transparent;
            color: var(--primary);
            width: 32px;
            height: 32px;
            align-items: center;
        }

        .lite .episode-item.playing .episode-play {
            background: var(--primary);
        }
    </style>
</head>
<body>
    <header class="header">
      <h1 class="app-title">
        <i class="fas fa-play-circle"></i>
        Nonton Drama <span class="badge dub">Test</span>
      </h1>
    </header>

    <div class="search-container">
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="Cari drama..." autocomplete="off">
            <button class="search-btn" onclick="searchDrama()">
                <i class="fas fa-search"></i>
            </button>
        </div>
    </div>

    <div class="categories">
        <button class="category-btn active" onclick="loadLatest()">Terbaru</button>
        <button class="category-btn" onclick="loadTrending()">Trending</button>
    </div>

    <main class="content" id="content">
        <div class="loading">
            <div class="loading-spinner"></div>
            <p>Memuat...</p>
        </div>
    </main>

    <div class="video-container" id="videoContainer">
        <video class="video-player" id="videoPlayer" controls playsinline></video>
        <div class="video-controls">
          <button class="back-btn" onclick="goBack()">
            <i class="fas fa-arrow-left"></i>
          </button>

          <div style="display:flex;gap:10px;align-items:center">
            <select id="resolutionSelect" class="resolution-select"></select>

            <button class="back-btn" onclick="prevEpisode()">
              <i class="fas fa-backward"></i>
            </button>
            <button class="back-btn" onclick="nextEpisode()">
              <i class="fas fa-forward"></i>
            </button>
          </div>
        </div>
    </div>

    <nav class="bottom-nav">
        <button class="nav-btn active" onclick="navigateHome()">
            <i class="fas fa-home"></i>
            Home
        </button>
        <button class="nav-btn" onclick="navigateBack()">
            <i class="fas fa-arrow-left"></i>
            Kembali
        </button>
    </nav>

    <script>
      let currentEpisodes = [];
      let currentEpisodeIndex = -1;
      let currentVideoSources = {};
      let currentTimeCache = 0;
      
      let searchState = {
          query: '',
          offset: 0,
          limit: 10,
          hasMore: false,
          loading: false,
          totalResults: []
      };

      let historyStack = [];
      let currentPage = {
          type: 'home',
          data: null
      };

      const API_BASE = "https://melolo-api-azure.vercel.app/api/melolo";

      const PROXY_LIST = [
        'https://api.codetabs.com/v1/proxy?quest=',
        'https://thingproxy.freeboard.io/fetch/',
        'https://api.allorigins.win/raw?url='
      ];

      const cache = new Map();
      const CACHE_DURATION = 5 * 60 * 1000;

      const content = document.getElementById("content");
      const videoContainer = document.getElementById("videoContainer");
      const videoPlayer = document.getElementById("videoPlayer");
      const searchInput = document.getElementById("searchInput");

      document.addEventListener("DOMContentLoaded", () => {
        navigateHome();
        searchInput.addEventListener("keypress", e => {
          if (e.key === "Enter") searchDrama();
        });
        if (IS_LITE) {
          document.querySelector(".app-title")
            .insertAdjacentHTML("beforeend",
              `<span class="badge saved">LITE</span>`);
        }
        
        setupInfiniteScroll();
      });

      function setupInfiniteScroll() {
        window.addEventListener('scroll', handleScroll);
      }

      function handleScroll() {
        if (searchState.loading || !searchState.hasMore) return;
        
        const scrollTop = window.scrollY || document.documentElement.scrollTop;
        const scrollHeight = document.documentElement.scrollHeight;
        const clientHeight = window.innerHeight;
        
        if (scrollTop + clientHeight >= scrollHeight - 300) {
          loadMoreSearch();
        }
      }

      function addToHistory(page) {
        historyStack.push({...currentPage});
        currentPage = page;
      }

      function navigateBack() {
        if (videoContainer.style.display === "block") {
          videoContainer.style.display = "none";
          videoPlayer.pause();
          videoPlayer.src = "";
          currentTimeCache = 0;
          return;
        }
        
        if (historyStack.length === 0) {
          navigateHome();
          return;
        }
        
        const prevPage = historyStack.pop();
        currentPage = prevPage;
        
        switch(prevPage.type) {
          case 'home':
            loadLatest();
            break;
          case 'trending':
            loadTrending();
            break;
          case 'search':
            restoreSearch(prevPage.data);
            break;
          case 'detail':
            if (prevPage.data && prevPage.data.prevPage) {
                const pageBeforeDetail = prevPage.data.prevPage;
                currentPage = pageBeforeDetail;
                
                switch(pageBeforeDetail.type) {
                    case 'home':
                        loadLatest();
                        break;
                    case 'trending':
                        loadTrending();
                        break;
                    case 'search':
                        restoreSearch(pageBeforeDetail.data);
                        break;
                    default:
                        navigateHome();
                }
            } else {
                navigateHome();
            }
            break;
        }
      }

      function navigateHome() {
        historyStack = [];
        currentPage = { type: 'home', data: null };
        loadLatest();
      }

      function restoreSearch(data) {
        if (data && data.query) {
            searchInput.value = data.query;
            performSearchRestore(data.query);
        } else {
            navigateHome();
        }
      }

      async function performSearchRestore(query) {
        searchState = {
            query: query,
            offset: 0,
            limit: 10,
            hasMore: false,
            loading: false,
            totalResults: []
        };

        showSearchLoading();

        try {
          const json = await smartFetch("search", { 
            query: query,
            limit: searchState.limit,
            offset: searchState.offset
          });

          const data = json?.data;
          const groups = data?.search_data || [];

          const books = groups.flatMap(g => g.books || []);

          if (!books.length) {
            showError(`Tidak ada drama ditemukan untuk "${query}"`);
            return;
          }

          searchState.totalResults = books;
          searchState.hasMore = data?.has_more || false;
          searchState.offset = data?.next_offset || searchState.offset + searchState.limit;

          renderSearchResults(books, true);
          setActiveCategory('none');
        } catch (e) {
          console.error(e);
          showError("Pencarian gagal");
        }
      }

      async function smartFetch(endpoint, params = {}) {
        const cacheKey = endpoint + JSON.stringify(params);
        const cached = cache.get(cacheKey);

        if (cached && Date.now() - cached.time < CACHE_DURATION) {
          return cached.data;
        }

        const url = new URL(`${API_BASE}/${endpoint}`);
        Object.entries(params).forEach(([k, v]) => url.searchParams.append(k, v));
        const target = url.toString();

        async function tryFetch(fetchUrl) {
          try {
            const r = await fetch(fetchUrl);
            if (!r.ok) return null;
            const ct = r.headers.get("content-type") || "";
            if (!ct.includes("json")) return null;
            return await r.json();
          } catch {
            return null;
          }
        }

        let data = await tryFetch(target);
        if (!data) {
          for (const p of PROXY_LIST) {
            data = await tryFetch(p + encodeURIComponent(target));
            if (data) break;
          }
        }

        if (!data) throw "fetch failed";

        cache.set(cacheKey, { data, time: Date.now() });
        return data;
      }

      async function loadLatest(data = null) {
        showLoading();
        try {
          const json = await smartFetch("latest");
          setActiveCategory("latest");
          renderGrid(json.books || []);
        } catch {
          showError("Gagal memuat terbaru");
        }
      }

      async function loadTrending(data = null) {
        addToHistory({ type: 'trending', data: data });
        showLoading();
        try {
          const json = await smartFetch("trending");
          setActiveCategory("trending");
          renderGrid(json.books || []);
        } catch {
          showError("Gagal memuat trending");
        }
      }

      async function searchDrama() {
        const q = searchInput.value.trim();
        if (!q) return;

        addToHistory({
          type: 'search',
          data: {
            query: q
          }
        });

        searchState = {
            query: q,
            offset: 0,
            limit: 10,
            hasMore: false,
            loading: false,
            totalResults: []
        };

        showSearchLoading();

        try {
          const json = await smartFetch("search", { 
            query: q,
            limit: searchState.limit,
            offset: searchState.offset
          });

          const data = json?.data;
          const groups = data?.search_data || [];

          const books = groups.flatMap(g => g.books || []);

          if (!books.length) {
            showError("Drama tidak ditemukan");
            historyStack.pop();
            return;
          }

          searchState.totalResults = books;
          searchState.hasMore = data?.has_more || false;
          searchState.offset = data?.next_offset || searchState.offset + searchState.limit;

          renderSearchResults(books, true);
          setActiveCategory('none');
        } catch (e) {
          console.error(e);
          showError("Pencarian gagal");
          historyStack.pop();
        }
      }

      async function loadMoreSearch() {
        if (searchState.loading || !searchState.hasMore) return;
        
        searchState.loading = true;
        
        try {
          const json = await smartFetch("search", { 
            query: searchState.query,
            limit: searchState.limit,
            offset: searchState.offset
          });

          const data = json?.data;
          const groups = data?.search_data || [];

          const newBooks = groups.flatMap(g => g.books || []);

          if (newBooks.length) {
            searchState.totalResults = [...searchState.totalResults, ...newBooks];
            searchState.hasMore = data?.has_more || false;
            searchState.offset = data?.next_offset || searchState.offset + searchState.limit;
            
            renderSearchResults(searchState.totalResults, false);
          }
        } catch (e) {
          console.error(e);
        } finally {
          searchState.loading = false;
        }
      }

      function showSearchLoading() {
        content.innerHTML = `
          <div class="loading">
            <div class="loading-spinner"></div>
            <p>Mencari "${searchState.query}"...</p>
          </div>
        `;
      }

      function renderSearchResults(books, isInitial = true) {
        if (!books.length) return showError("Tidak ada drama ditemukan");
        
        if (isInitial) {
          content.innerHTML = `
            <div class="grid" id="searchGrid">
              ${books.map(b => `
                <div class="card" data-book-id="${b.book_id}">
                  ${renderBadges(b)}
                  <div class="card-img">
                    <img src="${thumbProxy(b.thumb_url)}"
                         loading="lazy"
                         decoding="async">
                  </div>
                  <div class="card-info">
                    <div class="card-title">
                      ${escapeHTML(b.search_high_light?.title?.rich_text || b.book_name)}
                    </div>
                    <div class="card-meta">${b.show_creation_status || ""}</div>
                  </div>
                </div>
              `).join("")}
            </div>
            ${searchState.hasMore ? `
              <div class="load-more">
                <button class="load-more-btn" onclick="loadMoreSearch()">
                  Muat Lebih Banyak
                </button>
              </div>
            ` : ''}
          `;
          
          setTimeout(() => setupSearchCardListeners(), 100);
        } else {
          const grid = document.getElementById("searchGrid");
          if (!grid) return;
          
          books.slice(-searchState.limit).forEach(b => {
            const card = document.createElement("div");
            card.className = "card";
            card.setAttribute('data-book-id', b.book_id);
            card.innerHTML = `
              ${renderBadges(b)}
              <div class="card-img">
                <img src="${thumbProxy(b.thumb_url)}"
                     loading="lazy"
                     decoding="async">
              </div>
              <div class="card-info">
                <div class="card-title">
                  ${escapeHTML(b.search_high_light?.title?.rich_text || b.book_name)}
                </div>
                <div class="card-meta">${b.show_creation_status || ""}</div>
              </div>
            `;
            card.addEventListener('click', () => loadDetail(b.book_id));
            grid.appendChild(card);
          });
          
          updateLoadMoreButton();
        }
      }

      function setupSearchCardListeners() {
        const cards = document.querySelectorAll('#searchGrid .card');
        cards.forEach(card => {
          const bookId = card.getAttribute('data-book-id');
          if (bookId) {
            card.addEventListener('click', () => loadDetail(bookId));
          }
        });
      }

      function updateLoadMoreButton() {
        const loadMoreBtn = document.querySelector('.load-more-btn');
        if (loadMoreBtn) {
          if (!searchState.hasMore) {
            loadMoreBtn.parentElement.remove();
          } else if (searchState.loading) {
            loadMoreBtn.disabled = true;
            loadMoreBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Memuat...';
          } else {
            loadMoreBtn.disabled = false;
            loadMoreBtn.textContent = 'Muat Lebih Banyak';
          }
        } else if (searchState.hasMore && document.querySelector('.grid')) {
          const loadMoreDiv = document.createElement('div');
          loadMoreDiv.className = 'load-more';
          loadMoreDiv.innerHTML = `
            <button class="load-more-btn" onclick="loadMoreSearch()">
              Muat Lebih Banyak
            </button>
          `;
          content.appendChild(loadMoreDiv);
        }
      }

      function renderGrid(books) {
        if (!books.length) return showError("Tidak ada drama");
        if (IS_LITE) return renderGridLite(books);

        content.innerHTML = `
          <div class="grid" id="mainGrid">
            ${books.map(b => `
              <div class="card" data-book-id="${b.book_id}">
                ${renderBadges(b)}
                <div class="card-img">
                  <img src="${thumbProxy(b.thumb_url)}"
                       loading="lazy"
                       decoding="async">
                </div>
                <div class="card-info">
                  <div class="card-title">
                    ${escapeHTML(b.search_high_light?.title?.rich_text || b.book_name)}
                  </div>
                  <div class="card-meta">${b.show_creation_status || ""}</div>
                </div>
              </div>
            `).join("")}
          </div>
        `;
        
        setTimeout(() => setupGridCardListeners(), 100);
      }

      function setupGridCardListeners() {
        const cards = document.querySelectorAll('#mainGrid .card');
        cards.forEach(card => {
          const bookId = card.getAttribute('data-book-id');
          if (bookId) {
            card.addEventListener('click', () => loadDetail(bookId));
          }
        });
      }

      function renderGridLite(books) {
        content.innerHTML = `<div class="grid" id="grid"></div>`;
        const grid = document.getElementById("grid");

        let i = 0;
        const CHUNK = 6;

        function renderChunk() {
          const slice = books.slice(i, i + CHUNK);

          slice.forEach(b => {
            const card = document.createElement("div");
            card.className = "card";
            card.setAttribute('data-book-id', b.book_id);
            card.innerHTML = `
              ${renderBadges(b)}
              <div class="card-img">
                <img src="${thumbProxy(b.thumb_url)}"
                     loading="lazy"
                     decoding="async">
              </div>
              <div class="card-info">
                <div class="card-title">${escapeHTML(b.book_name)}</div>
                <div class="card-meta">${b.show_creation_status || ""}</div>
              </div>
            `;
            card.addEventListener('click', () => loadDetail(b.book_id));
            grid.appendChild(card);
          });

          i += CHUNK;
          if (i < books.length) {
            requestAnimationFrame(renderChunk);
          }
        }

        renderChunk();
      }

      async function loadDetail(bookId, addHistory = true) {
        if (addHistory) {
          addToHistory({
            type: 'detail',
            data: {
              bookId: bookId,
              prevPage: {...currentPage}
            }
          });
        }
        
        showLoading();
        try {
          const json = await smartFetch(`detail/${bookId}`);
          const data = json.data.video_data;

          currentEpisodes = data.video_list;

          function formatDuration(seconds) {
            if (!seconds) return "0:00";
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
          }

          function formatNumber(num) {
            if (!num) return "0";
            if (num >= 1000000) return (num / 1000000).toFixed(1) + "Jt";
            if (num >= 1000) return (num / 1000).toFixed(1) + "rb";
            return num.toString();
          }

          const sortedEpisodes = [...currentEpisodes].sort((a, b) => {
            return (parseInt(a.vid_index) || 0) - (parseInt(b.vid_index) || 0);
          });

          content.innerHTML = `
            <h2 class="detail-title">${data.series_title}</h2>
            <div class="episode-list">
                ${sortedEpisodes.map((v, i) => {
                    const episodeNum = v.vid_index || (i + 1);
                    const duration = v.duration ? formatDuration(v.duration) : "N/A";
                    
                    return `
                    <div class="episode-item" data-episode-index="${i}" onclick="playEpisode(${i})">
                        <div class="episode-info">
                            <div class="episode-number">
                                <span>Episode ${episodeNum}</span>
                                ${v.is_new === "1" ? '<span class="ep-badge">BARU</span>' : ''}
                            </div>
                            <div class="episode-meta">
                                <span class="episode-duration">
                                    <i class="far fa-clock"></i> ${duration}
                                </span>
                                ${v.upload_date ? `<span><i class="far fa-calendar"></i> ${v.upload_date}</span>` : ''}
                                ${v.views ? `<span><i class="far fa-eye"></i> ${formatNumber(v.views)}x</span>` : ''}
                            </div>
                        </div>
                        <div class="episode-play">
                            <i class="fas fa-play"></i>
                        </div>
                    </div>
                    `;
                }).join("")}
            </div>
        `;
        } catch {
          showError("Detail gagal dimuat");
          if (addHistory) {
            historyStack.pop();
          }
        }
      }

      function decodeUrl(str) {
        if (!str) return null;
        if (str.startsWith("http")) return str;

        try {
          return atob(str);
        } catch {
          return null;
        }
      }

      async function playVideo(vid) {
        try {
            if (currentTimeCache === undefined) {
                currentTimeCache = 0;
            }
            const json = await smartFetch(`stream/${vid}`);
            const data = json?.data;

            let videoModel = data?.video_model;
            if (typeof videoModel === "string") {
                videoModel = JSON.parse(videoModel);
            }

            const list = videoModel?.video_list;
            if (!list) throw "no sources";

            currentVideoSources = {};
            const resolutions = [];

            Object.entries(list).forEach(([key, v]) => {
                if (!v?.main_url) return;

                const url = decodeUrl(v.main_url);
                if (!url) return;

                const resKey = v.definition || key.replace("video_", "") + "p";
                const resNum = parseInt(resKey) || 0;
                
                resolutions.push({
                    label: resKey,
                    value: resKey,
                    url: url,
                    numeric: resNum
                });
                
                currentVideoSources[resKey] = url;
            });

            if (!resolutions.length && data?.main_url) {
                resolutions.push({
                    label: "Auto",
                    value: "Auto",
                    url: data.main_url,
                    numeric: 0
                });
                currentVideoSources["Auto"] = data.main_url;
            }

            resolutions.sort((a, b) => {
                const aNum = parseResolutionNumber(a.label);
                const bNum = parseResolutionNumber(b.label);
                return aNum - bNum;
            });

            const select = document.getElementById("resolutionSelect");
            select.innerHTML = "";
            
            resolutions.forEach(res => {
                const opt = document.createElement("option");
                opt.value = res.value;
                opt.textContent = res.label;
                select.appendChild(opt);
            });

            if (!resolutions.length) throw "no playable url";

            select.value = resolutions[0].value;

            const auto = videoModel?.auto_definition;
            if (auto && currentVideoSources[auto]) {
                const autoRes = resolutions.find(r => r.value === auto);
                if (autoRes) {
                    select.value = auto;
                }
            }

            if (IS_LITE) {
                videoPlayer.preload = "metadata";
                videoPlayer.controlsList = "nofullscreen noremoteplayback";
            }

            videoPlayer.src = currentVideoSources[select.value];
            videoContainer.style.display = "block";
            videoPlayer.load();

            if (IS_LITE) {
                setupLiteControls();
            } else {
                setupVideoControls();
                setupSelectDropdown();
                showVideoControls();
            }

            videoPlayer.onloadedmetadata = () => {
                videoPlayer.currentTime = currentTimeCache;
                videoPlayer.play().catch(() => {});
            };

            select.onchange = () => switchResolution(select.value);

        } catch (e) {
            console.error(e);
            alert("Video gagal diputar");
        }
    }
    
    function parseResolutionNumber(resStr) {
        if (!resStr) return 0;
        
        const match = resStr.match(/\d+/);
        if (match) {
            return parseInt(match[0]);
        }
        
        const lower = resStr.toLowerCase();
        if (lower.includes('4k') || lower.includes('2160')) return 2160;
        if (lower.includes('1080') || lower.includes('fhd')) return 1080;
        if (lower.includes('720') || lower.includes('hd')) return 720;
        if (lower.includes('480') || lower.includes('sd')) return 480;
        if (lower.includes('360')) return 360;
        if (lower.includes('240')) return 240;
        if (lower.includes('144')) return 144;
        
        return 0;
    }

      function goBack() {
        if (videoContainer.style.display === "block") {
            document.querySelectorAll('.episode-item').forEach(item => {
                item.classList.remove('playing');
            });
            
            videoContainer.style.display = "none";
            videoPlayer.pause();
            videoPlayer.src = "";
            currentTimeCache = 0;
            
            const episodeDisplay = document.querySelector('.episode-display');
            if (episodeDisplay) {
                episodeDisplay.remove();
            }
        } else {
            navigateBack();
        }
      }

      function focusSearch() {
        searchInput.focus();
      }

      function setActiveCategory(type) {
        document.querySelectorAll(".category-btn").forEach(b => b.classList.remove("active"));
        if (type === "latest") document.querySelectorAll(".category-btn")[0]?.classList.add("active");
        if (type === "trending") document.querySelectorAll(".category-btn")[1]?.classList.add("active");
        if (type === "none") {
          document.querySelectorAll(".category-btn").forEach(b => b.classList.remove("active"));
        }
      }

      function showLoading() {
        content.innerHTML = `
          <div class="loading">
            <div class="loading-spinner"></div>
            <p>Memuat...</p>
          </div>
        `;
      }

      function showError(msg) {
        content.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon"><i class="fas fa-exclamation-circle"></i></div>
            <p>${msg}</p>
          </div>
        `;
      }

      function playEpisode(index) {
        if (!currentEpisodes[index]) return;
        
        document.querySelectorAll('.episode-item').forEach(item => {
            item.classList.remove('playing');
        });
        
        const episodeItem = document.querySelector(`.episode-item[data-episode-index="${index}"]`);
        if (episodeItem) {
            episodeItem.classList.add('playing');
            episodeItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
        
        currentTimeCache = 0;
        currentEpisodeIndex = index;
        
        updateVideoControlsEpisodeInfo(index);
        
        playVideo(currentEpisodes[index].vid);
      }
      
      function nextEpisode() {
        if (currentEpisodeIndex < currentEpisodes.length - 1) {
          playEpisode(currentEpisodeIndex + 1);
        } else {
          alert("Ini adalah episode terakhir");
        }
      }

      function prevEpisode() {
        if (currentEpisodeIndex > 0) {
          playEpisode(currentEpisodeIndex - 1);
        } else {
          alert("Ini adalah episode pertama");
        }
      }

      function updateVideoControlsEpisodeInfo(index) {
        const episode = currentEpisodes[index];
        if (!episode) return;
        
        const episodeNum = episode.vid_index || (index + 1);
        const episodeTitle = episode.video_title || `Episode ${episodeNum}`;
        
        let episodeDisplay = document.querySelector('.episode-display');
        if (!episodeDisplay) {
            episodeDisplay = document.createElement('div');
            episodeDisplay.className = 'episode-display';
            document.querySelector('.video-controls').appendChild(episodeDisplay);
        }
        
        episodeDisplay.innerHTML = `
            <div class="episode-display-content">
                ${escapeHTML(episodeTitle)}
            </div>
        `;
      }

      videoPlayer.addEventListener("ended", () => {
        setTimeout(() => {
            nextEpisode();
        }, 1000);
      });

      videoPlayer.addEventListener("playing", () => {
        if (currentEpisodeIndex >= 0) {
            updateVideoControlsEpisodeInfo(currentEpisodeIndex);
        }
      });

      videoPlayer.setAttribute("playsinline", true);
      videoPlayer.setAttribute("webkit-playsinline", true);
      
      let controlsTimeout;
      let isControlsVisible = false;
      let isSelectOpen = false;
      let liteControlsTimeout;

      function showVideoControls() {
        const c = document.querySelector(".video-controls");
        if (!c) return;
        
        c.style.opacity = "1";
        isControlsVisible = true;
        
        if (isSelectOpen) return;
        
        clearTimeout(controlsTimeout);
        controlsTimeout = setTimeout(() => {
            if (!videoPlayer.paused && !videoPlayer.ended && !isSelectOpen) {
                c.style.opacity = "0";
                isControlsVisible = false;
            }
        }, 2500);
      }

      function hideVideoControls() {
        if (isSelectOpen) return;
        
        const c = document.querySelector(".video-controls");
        if (!c) return;
        
        c.style.opacity = "0";
        isControlsVisible = false;
      }

      function setupSelectDropdown() {
        const select = document.getElementById("resolutionSelect");
        if (!select) return;
        
        isSelectOpen = false;
        
        select.addEventListener('focus', () => {
            isSelectOpen = true;
            clearTimeout(controlsTimeout);
            showVideoControls();
        });
        
        select.addEventListener('blur', () => {
            isSelectOpen = false;
            showVideoControls();
        });
        
        select.addEventListener('touchstart', () => {
            isSelectOpen = true;
            clearTimeout(controlsTimeout);
        });
        
        select.addEventListener('touchend', () => {
            setTimeout(() => {
                if (document.activeElement !== select) {
                    isSelectOpen = false;
                    showVideoControls();
                }
            }, 300);
        });
        
        select.addEventListener('change', () => {
            setTimeout(() => {
                isSelectOpen = false;
                if (document.activeElement !== select) {
                    showVideoControls();
                }
            }, 200);
        });
      }

      function setupVideoControls() {
        if ('ontouchstart' in window || navigator.maxTouchPoints) {
            videoContainer.addEventListener('touchstart', showVideoControls);
            videoContainer.addEventListener('touchmove', showVideoControls);
            videoContainer.addEventListener('click', showVideoControls);
        } else {
            videoContainer.addEventListener('mousemove', showVideoControls);
            videoContainer.addEventListener('click', showVideoControls);
        }
        
        videoPlayer.addEventListener('pause', () => {
            showVideoControls();
            clearTimeout(controlsTimeout);
        });
        
        videoPlayer.addEventListener('play', () => {
            if (isSelectOpen) return;
            
            controlsTimeout = setTimeout(() => {
                if (!videoPlayer.paused && !isSelectOpen) {
                    hideVideoControls();
                }
            }, 2500);
        });
        
        videoPlayer.addEventListener('ended', () => {
            showVideoControls();
            clearTimeout(controlsTimeout);
        });
      }

      function showControlsLite() {
        const c = document.querySelector(".video-controls");
        if (!c) return;
        
        c.style.opacity = "1";
        clearTimeout(liteControlsTimeout);
        
        if (!videoPlayer.paused && !videoPlayer.ended) {
            liteControlsTimeout = setTimeout(() => {
                if (!videoPlayer.paused) {
                    c.style.opacity = "0";
                }
            }, 4000);
        }
      }

      function setupLiteControls() {
        const select = document.getElementById("resolutionSelect");
        const c = document.querySelector(".video-controls");
        if (c) c.style.opacity = "1";
        
        if ('ontouchstart' in window) {
            videoContainer.addEventListener('touchstart', (e) => {
                if (e.target === select || select.contains(e.target)) {
                    clearTimeout(liteControlsTimeout);
                    return;
                }
                showControlsLite();
            });
            
            if (select) {
                select.addEventListener('touchstart', () => {
                    clearTimeout(liteControlsTimeout);
                    const c = document.querySelector(".video-controls");
                    if (c) c.style.opacity = "1";
                });
                
                select.addEventListener('change', () => {
                    setTimeout(() => {
                        if (!videoPlayer.paused) {
                            liteControlsTimeout = setTimeout(() => {
                                const c = document.querySelector(".video-controls");
                                if (c && !videoPlayer.paused) c.style.opacity = "0";
                            }, 4000);
                        }
                    }, 1000);
                });
            }
        } else {
            videoContainer.addEventListener('click', showControlsLite);
        }
        
        videoPlayer.addEventListener('pause', () => {
            const c = document.querySelector(".video-controls");
            if (c) c.style.opacity = "1";
            clearTimeout(liteControlsTimeout);
        });
        
        videoPlayer.addEventListener('play', () => {
            liteControlsTimeout = setTimeout(() => {
                const c = document.querySelector(".video-controls");
                if (c && !videoPlayer.paused) c.style.opacity = "0";
            }, 4000);
        });
      }

      const videoObserver = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
            if (mutation.attributeName === 'style') {
                if (videoContainer.style.display === 'block') {
                    if (!IS_LITE) {
                        setupVideoControls();
                        setupSelectDropdown();
                        showVideoControls();
                    }
                } else {
                    isSelectOpen = false;
                    clearTimeout(controlsTimeout);
                    clearTimeout(liteControlsTimeout);
                }
            }
        });
      });

      videoObserver.observe(videoContainer, { attributes: true });

      function thumbProxy(url) {
        if (!url) return "";
        const size = IS_LITE ? 240 : 400;
        const quality = IS_LITE ? 60 : 80;

        return `https://images.weserv.nl/?url=${encodeURIComponent(url)}&w=${size}&q=${quality}&output=jpg`;
      }

      function renderBadges(b) {
        const badges = [];

        if (b.is_hot === "1") badges.push(`<span class="badge hot"> HOT</span>`);
        if (b.is_new_book === "1") badges.push(`<span class="badge new">NEW</span>`);
        if (b.is_exclusive === "1") badges.push(`<span class="badge exclusive">EXCLUSIVE</span>`);
        if (b.is_dubbed === "1") badges.push(`<span class="badge dub">DUB</span>`);
        if (b.is_native === "1") badges.push(`<span class="badge original">ORIGINAL</span>`);
        if (b.in_bookshelf === "1") badges.push(`<span class="badge saved">SAVED</span>`);

        if (!badges.length) return "";
        return `<div class="badges">${badges.join("")}</div>`;
      }

      function escapeHTML(str = "") {
        return str.replace(/[&<>"']/g, m => ({
          "&":"&amp;",
          "<":"&lt;",
          ">":"&gt;",
          '"':"&quot;",
          "'":"&#039;"
        }[m]));
      }

      function switchResolution(res) {
        if (!currentVideoSources[res]) return;

        updateVideoControlsEpisodeInfo(currentEpisodeIndex);
        
        currentTimeCache = videoPlayer.currentTime;
        videoPlayer.src = currentVideoSources[res];
        videoPlayer.load();

        videoPlayer.onloadedmetadata = () => {
          videoPlayer.currentTime = currentTimeCache;
          videoPlayer.play().catch(() => {});
        };
      }

      let scrollTimer;
      window.addEventListener("scroll", () => {
        document.body.classList.add("scrolling");
        clearTimeout(scrollTimer);
        scrollTimer = setTimeout(() => {
          document.body.classList.remove("scrolling");
        }, 150);
      }, { passive: true });

      document.addEventListener("touchmove", () => {}, { passive: true });
    </script>
    <div class="global-watermark"> emenodon</div>
</body>
</html>
