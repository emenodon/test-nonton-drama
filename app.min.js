const API_BASE="https://melolo-api-azure.vercel.app/api/melolo",PROXY_LIST=["https://api.codetabs.com/v1/proxy?quest=","https://thingproxy.freeboard.io/fetch/","https://api.allorigins.win/raw?url="],cache=new Map,CACHE_DURATION=3e5;async function smartFetch(e,t={}){const n=`${e}_${JSON.stringify(t)}`,a=cache.get(n);if(a&&Date.now()-a.timestamp<3e5)return a.data;const i=new URL(`${API_BASE}/${e}`);Object.entries(t).forEach(([e,t])=>{null!=t&&i.searchParams.append(e,t)});const o=i.toString();let s=null;try{const e=await fetch(o,{headers:{Accept:"application/json","Cache-Control":"max-age=300"},signal:AbortSignal.timeout(8e3)});e.ok&&(s=await e.json())}catch(e){}if(!s)for(const e of PROXY_LIST)try{const t=e+encodeURIComponent(o),n=await fetch(t,{signal:AbortSignal.timeout(8e3)});if(n.ok&&(s=await n.json(),s))break}catch(e){continue}if(!s)throw new Error("Failed to fetch data");return cache.set(n,{data:s,timestamp:Date.now()}),s}async function loadLatestDramas(){try{return(await smartFetch("latest")).books||[]}catch(e){throw e}}async function loadTrendingDramas(){try{return(await smartFetch("trending")).books||[]}catch(e){throw e}}async function searchDramas(e,t=20,n=0){try{const a=await smartFetch("search",{query:e,limit:t,offset:n}),i=(a?.data?.search_data||[]).flatMap(e=>e.books||[]);return{results:i,hasMore:a?.data?.has_more||!1,total:i.length}}catch(e){throw e}}async function loadDramaDetail(e){try{const t=await smartFetch(`detail/${e}`),n=t?.data?.video_data||{};return{id:e,title:n.series_title||"Unknown",description:n.series_intro||"",thumbnail:n.series_cover||n.thumb_url||"",episodes:n.video_list||[],totalEpisodes:n.video_list?.length||0}}catch(e){throw e}}async function loadVideoSources(e){try{const t=await smartFetch(`stream/${e}`),n=t?.data;if(!n)throw new Error("No video data found");const a={mainUrl:n.main_url?decodeUrl(n.main_url):null,sources:[],autoDefinition:null};let i=n.video_model;if("string"==typeof i)try{i=JSON.parse(i)}catch(e){i=null}return i&&i.video_list&&(Object.entries(i.video_list).forEach(([e,t])=>{if(t?.main_url){const n=decodeUrl(t.main_url);if(n){const i=t.definition||e.replace("video_","")+"p";a.sources.push({resolution:i,label:i,url:n})}}}),a.autoDefinition=i.auto_definition),a.sources.sort((e,t)=>{const n=parseInt(e.resolution)||0;return(parseInt(t.resolution)||0)-n}),0===a.sources.length&&a.mainUrl&&a.sources.push({resolution:"auto",label:"Auto",url:a.mainUrl}),a}catch(e){throw new Error("Failed to load video sources")}}function decodeUrl(e){if(!e)return null;if(e.startsWith("http"))return e;try{return atob(e)}catch(t){return e}}function proxyThumbnail(e,t={}){if(!e)return"";const{width:n=400,quality:a=80,format:i="jpg"}=t;return`https://images.weserv.nl/?url=${encodeURIComponent(e)}&w=${n}&q=${a}&output=${i}`}function clearCache(){cache.clear()}function escapeHTML(e){if(!e)return"";const t=document.createElement("div");return t.textContent=e,t.innerHTML}function highlightText(e,t){if(!t||!e)return escapeHTML(e);const n=new RegExp(`(${t})`,"gi");return escapeHTML(e).replace(n,'<em class="highlight">$1</em>')}function formatDuration(e){if(!e)return"0:00";return`${Math.floor(e/60)}:${Math.floor(e%60).toString().padStart(2,"0")}`}function formatNumber(e){return e?e>=1e6?(e/1e6).toFixed(1)+"Jt":e>=1e3?(e/1e3).toFixed(1)+"rb":e.toString():"0"}function renderLoading(e="Memuat..."){const t=document.getElementById("content");t&&(t.innerHTML=`\n        <div class="loading">\n            <div class="loading-spinner"></div>\n            <p>${escapeHTML(e)}</p>\n        </div>\n    `)}function renderError(e){const t=document.getElementById("content");t&&(t.innerHTML=`\n        <div class="empty-state">\n            <div class="empty-icon"><i class="fas fa-exclamation-circle"></i></div>\n            <p>${escapeHTML(e)}</p>\n            <button class="retry-btn" onclick="window.location.reload()">\n                Coba Lagi\n            </button>\n        </div>\n    `)}function renderGrid(e,t="latest"){const n=document.getElementById("content");if(!n)return;if(!e||0===e.length)return void renderError("Tidak ada drama ditemukan");const a=document.documentElement.classList.contains("lite");let i=`<div class="${a?"grid lite":"grid"}">`;e.forEach(e=>{if(!e.book_id)return;const t=getBadgesHTML(e),n=highlightText(e.search_high_light?.title?.rich_text||e.book_name,window.AppState?.searchQuery||""),o=proxyThumbnail(e.thumb_url,{width:a?120:200,quality:a?60:80});i+=`\n            <div class="card" data-book-id="${e.book_id}">\n                ${t}\n                <div class="card-img">\n                    <img src="${o}" \n                         alt="${escapeHTML(e.book_name)}"\n                         loading="lazy"\n                         decoding="async"\n                         onerror="this.src='https://placehold.co/${a?"120x180":"200x300"}/1e293b/94a3b8?text=${encodeURIComponent(e.book_name||"Drama")}'">\n                </div>\n                <div class="card-info">\n                    <div class="card-title">\n                        ${n}\n                    </div>\n                    <div class="card-meta">\n                        ${escapeHTML(e.show_creation_status||"")}\n                    </div>\n                </div>\n            </div>\n        `}),i+="</div>",n.innerHTML=i,setTimeout(()=>{document.querySelectorAll(".card[data-book-id]").forEach(e=>{const t=e.getAttribute("data-book-id");t&&e.addEventListener("click",()=>{window.dispatchEvent(new CustomEvent("app-event",{detail:{event:"drama-click",data:t}}))})})},50)}function renderDetail(e){const t=document.getElementById("content");if(!t)return;const n=document.documentElement.classList.contains("lite"),a=proxyThumbnail(e.thumbnail,{width:300,quality:85}),i=[...e.episodes||[]].sort((e,t)=>(parseInt(e.vid_index)||0)-(parseInt(t.vid_index)||0));t.innerHTML=n?renderDetailLite(e,a,i):renderDetailNormal(e,a,i),setTimeout(()=>{n?document.querySelectorAll(".episode-item-lite").forEach((e,t)=>{e.addEventListener("click",()=>{window.dispatchEvent(new CustomEvent("app-event",{detail:{event:"episode-click",data:t}}))})}):document.querySelectorAll(".episode-item").forEach((e,t)=>{e.addEventListener("click",()=>{window.dispatchEvent(new CustomEvent("app-event",{detail:{event:"episode-click",data:t}}))})}),setupExpandableDescription()},50)}function renderDetailNormal(e,t,n){return`\n        <div class="detail-container">\n            <div class="detail-thumbnail">\n                <img src="${t}" \n                     alt="${escapeHTML(e.title)}"\n                     loading="lazy"\n                     decoding="async">\n            </div>\n            <div class="detail-info">\n                <h2 class="detail-title">${escapeHTML(e.title)}</h2>\n                <div class="detail-episode-count">${e.totalEpisodes} Episode</div>\n                <div class="description-container">\n                    <div class="description-content">${escapeHTML(e.description)}</div>\n                    <button class="expand-btn">\n                        <span>Selengkapnya</span>\n                        <i class="fas fa-chevron-down"></i>\n                    </button>\n                </div>\n            </div>\n        </div>\n        \n        <div class="episodes-card">\n            <div class="episode-list-container">\n                ${n.map((e,t)=>renderEpisodeItem(e,t,!1)).join("")}\n            </div>\n        </div>\n    `}function renderDetailLite(e,t,n){return`\n        <div class="detail-container-lite">\n            <div class="detail-header-lite">\n                <div class="detail-thumbnail-lite">\n                    <img src="${t}" \n                         alt="${escapeHTML(e.title)}"\n                         loading="lazy"\n                         decoding="async">\n                </div>\n                <div class="detail-info-lite">\n                    <h2 class="detail-title">${escapeHTML(e.title)}</h2>\n                    <div class="detail-episode-count">${e.totalEpisodes} Episode</div>\n                </div>\n            </div>\n            <div class="description-lite">\n                <div class="description-content-lite">\n                    ${escapeHTML(e.description)}\n                </div>\n            </div>\n        </div>\n        \n        <div class="episodes-card-lite">\n            <div class="episode-list-lite">\n                ${n.map((e,t)=>renderEpisodeItem(e,t,!0)).join("")}\n            </div>\n        </div>\n    `}function renderEpisodeItem(e,t,n){const a=e.vid_index||t+1,i=e.duration?formatDuration(e.duration):"",o="1"===e.is_new;return n?`\n            <div class="episode-item-lite" data-episode-index="${t}">\n                <div class="episode-info-lite">\n                    <div class="episode-number-lite">\n                        <span>Episode ${a}</span>\n                        ${o?'<span class="ep-badge-lite">BARU</span>':""}\n                    </div>\n                    ${e.video_title?`\n                        <div class="episode-title-lite">\n                            ${escapeHTML(e.video_title)}\n                        </div>\n                    `:""}\n                    <div class="episode-meta-lite">\n                        ${i?`\n                            <span class="episode-duration-lite">\n                                <i class="far fa-clock"></i> ${i}\n                            </span>\n                        `:""}\n                        ${e.views?`\n                            <span><i class="far fa-eye"></i> ${formatNumber(e.views)}x</span>\n                        `:""}\n                    </div>\n                </div>\n                <div class="episode-play-lite">\n                    <i class="fas fa-play"></i>\n                </div>\n            </div>\n        `:`\n        <div class="episode-item" data-episode-index="${t}">\n            <div class="episode-info">\n                <div class="episode-number">\n                    <span>Episode ${a}</span>\n                    ${o?'<span class="ep-badge">BARU</span>':""}\n                </div>\n                <div class="episode-meta">\n                    ${i?`\n                        <span class="episode-duration">\n                            <i class="far fa-clock"></i> ${i}\n                        </span>\n                    `:""}\n                    ${e.upload_date?`\n                        <span><i class="far fa-calendar"></i> ${e.upload_date}</span>\n                    `:""}\n                    ${e.views?`\n                        <span><i class="far fa-eye"></i> ${formatNumber(e.views)}x</span>\n                    `:""}\n                </div>\n            </div>\n            <div class="episode-play">\n                <i class="fas fa-play"></i>\n            </div>\n        </div>\n    `}function renderSearchResults(e,t){const n=document.getElementById("content");if(!n)return;if(!e.results||0===e.results.length)return void renderError(`Tidak ada hasil untuk "${t}"`);const a=document.documentElement.classList.contains("lite"),i=a?"grid lite":"grid";let o=`\n        <div class="search-results-header">\n            <h4 style="word-break: break-word;">Hasil pencarian untuk "${escapeHTML(t)}"</h4>\n        </div>\n        <div class="${i}" id="searchGrid">\n    `;e.results.forEach(e=>{if(!e.book_id)return;const n=getBadgesHTML(e),i=highlightText(e.search_high_light?.title?.rich_text||e.book_name,t),s=proxyThumbnail(e.thumb_url,{width:a?120:200,quality:a?60:80});o+=`\n            <div class="card" data-book-id="${e.book_id}">\n                ${n}\n                <div class="card-img">\n                    <img src="${s}" \n                         alt="${escapeHTML(e.book_name)}"\n                         loading="lazy"\n                         decoding="async">\n                </div>\n                <div class="card-info">\n                    <div class="card-title">\n                        ${i}\n                    </div>\n                    <div class="card-meta">\n                        ${escapeHTML(e.show_creation_status||"")}\n                    </div>\n                </div>\n            </div>\n        `}),o+="</div>",e.hasMore&&(o+='\n            <div class="infinite-scroll-loading" id="infiniteScrollLoading" style="display: none;">\n                <div class="loading-spinner"></div>\n            </div>\n        '),n.innerHTML=o,setTimeout(()=>{document.querySelectorAll(".card[data-book-id]").forEach(e=>{const t=e.getAttribute("data-book-id");t&&e.addEventListener("click",()=>{window.dispatchEvent(new CustomEvent("app-event",{detail:{event:"drama-click",data:t}}))})}),setupInfiniteScroll()},50)}function setupInfiniteScroll(){if(!document.getElementById("infiniteScrollLoading"))return;let e=!1;const t=()=>{if(e)return;const t=window.scrollY||document.documentElement.scrollTop,a=document.documentElement.scrollHeight;t+window.innerHeight>=.8*a&&n()},n=async()=>{if(e||!window.AppState?.searchResults?.hasMore)return;e=!0;const t=document.getElementById("infiniteScrollLoading");t&&(t.style.display="block");try{const e=window.AppState.searchResults.results.length,t=await searchDramas(window.AppState.searchQuery,20,e);t.results&&t.results.length>0&&(window.AppState.searchResults.results=[...window.AppState.searchResults.results,...t.results],window.AppState.searchResults.hasMore=t.hasMore,a(t.results))}catch(e){console.error("Error loading more results:",e)}finally{e=!1;const t=document.getElementById("infiniteScrollLoading");t&&(t.style.display="none")}},a=e=>{const t=document.getElementById("searchGrid");if(!t)return;const n=document.documentElement.classList.contains("lite");e.forEach(e=>{if(!e.book_id)return;const a=getBadgesHTML(e),i=highlightText(e.search_high_light?.title?.rich_text||e.book_name,window.AppState.searchQuery),o=proxyThumbnail(e.thumb_url,{width:n?120:200,quality:n?60:80}),s=`\n                <div class="card" data-book-id="${e.book_id}">\n                    ${a}\n                    <div class="card-img">\n                        <img src="${o}" \n                             alt="${escapeHTML(e.book_name)}"\n                             loading="lazy"\n                             decoding="async">\n                    </div>\n                    <div class="card-info">\n                        <div class="card-title">\n                            ${i}\n                        </div>\n                        <div class="card-meta">\n                            ${escapeHTML(e.show_creation_status||"")}\n                        </div>\n                    </div>\n                </div>\n            `;t.insertAdjacentHTML("beforeend",s)}),setTimeout(()=>{document.querySelectorAll(".card[data-book-id]").forEach(e=>{if(e.onclick)return;const t=e.getAttribute("data-book-id");t&&e.addEventListener("click",()=>{window.dispatchEvent(new CustomEvent("app-event",{detail:{event:"drama-click",data:t}}))})})},10)};let i;window.addEventListener("scroll",()=>{clearTimeout(i),i=setTimeout(t,200)}),t()}async function handleEpisodeClick(e){if(!window.AppState?.currentDrama?.episodes)return;const t=window.AppState.currentDrama.episodes[e];if(!t?.vid)return;const n=document.querySelector(`[data-episode-index="${e}"]`);if(n){n.classList.add("loading");const e=n.querySelector(".episode-play i");e&&(e.className="fas fa-spinner fa-spin")}try{const n=await loadVideoSources(t.vid);openPlayer(t,n,e),window.currentEpisodeIndex=e}catch(e){if(n){n.classList.remove("loading");const e=n.querySelector(".episode-play i");e&&(e.className="fas fa-play")}alert("Gagal memuat video. Silakan coba lagi.")}}function getBadgesHTML(e){const t=[];if("1"===e.is_hot&&t.push({type:"hot",text:"HOT"}),"1"===e.is_new_book&&t.push({type:"new",text:"NEW"}),"1"===e.is_exclusive&&t.push({type:"exclusive",text:"EXCLUSIVE"}),"1"===e.is_dubbed&&t.push({type:"dub",text:"DUB"}),"1"===e.is_native&&t.push({type:"original",text:"ORIGINAL"}),"1"===e.in_bookshelf&&t.push({type:"saved",text:"SAVED"}),0===t.length)return"";return`<div class="badges">${t.map(e=>`<span class="badge ${e.type}">${e.text}</span>`).join("")}</div>`}function setupExpandableDescription(){const e=document.querySelector(".description-content"),t=document.querySelector(".expand-btn");if(!e||!t)return;const n=window.getComputedStyle(e),a=1.5*parseFloat(n.fontSize)*3;if(e.scrollHeight>a){e.classList.add("truncated"),t.style.display="flex";let n=!1;const a=t.querySelector("span"),i=t.querySelector("i");t.addEventListener("click",()=>{n?(e.classList.add("truncated"),a.textContent="Selengkapnya",i.className="fas fa-chevron-down",n=!1):(e.classList.remove("truncated"),a.textContent="Lebih Sedikit",i.className="fas fa-chevron-up",n=!0)})}else t.style.display="none"}window.apiUtils={smartFetch:smartFetch,clearCache:clearCache,cacheSize:()=>cache.size},window.components={renderGrid:renderGrid,renderDetail:renderDetail,renderSearchResults:renderSearchResults};const PlayerState={currentEpisode:null,sources:null,currentTime:0,isPlaying:!1,isLoading:!1,currentEpisodeIndex:-1,currentResolution:"auto",wasPlayingBeforeSwitch:!1};function initVideoPlayer(){let e=document.getElementById("videoContainer");e||(e=document.createElement("div"),e.id="videoContainer",e.className="video-container",e.style.display="none",document.body.appendChild(e)),setupFullscreenListeners()}function setupFullscreenListeners(){document.addEventListener("fullscreenchange",handleFullscreenChange),document.addEventListener("webkitfullscreenchange",handleFullscreenChange)}function openPlayer(e,t,n){PlayerState.currentEpisode=e,PlayerState.sources=t,PlayerState.currentEpisodeIndex=n,PlayerState.currentTime=0,PlayerState.isLoading=!0,PlayerState.wasPlayingBeforeSwitch=!1;const a=document.getElementById("videoContainer");if(!a)return;const i=document.documentElement.classList.contains("lite"),o=e.video_title||`Episode ${e.vid_index||n+1}`;let s;s=i?buildLitePlayerHTML(o,t):buildFullPlayerHTML(o,t),a.innerHTML=s,a.style.display="block",document.body.style.overflow="hidden",setTimeout(()=>{initializePlayerElements(),loadVideo(),setupPlayerEventListeners()},100)}function buildFullPlayerHTML(e,t){const n=t.sources||[];let a="";if(n.length>0&&n.forEach(e=>{const t=e.resolution===PlayerState.currentResolution;a+=`<option value="${e.resolution}" ${t?"selected":""}>${e.label}</option>`}),t.mainUrl){const e="auto"===PlayerState.currentResolution;a=`<option value="auto" ${e?"selected":""}>Auto</option>`+a}return`\n        <div class="video-player-wrapper">\n            <video \n                id="videoPlayer" \n                class="video-player" \n                playsinline \n                webkit-playsinline\n                preload="auto"\n            >\n                Your browser does not support the video tag.\n            </video>\n            \n            <div class="player-loading" id="playerLoading">\n                <div class="loading-spinner-large"></div>\n                <div class="loading-text">Memuat video...</div>\n            </div>\n            \n            <div class="video-controls" id="videoControls">\n                <div class="controls-top">\n                    <button class="control-btn back-btn" id="playerBackBtn">\n                        <i class="fas fa-arrow-left"></i>\n                    </button>\n                    \n                    <div class="episode-info">\n                        <div class="episode-title">${escapeHTML(e)}</div>\n                        ${n.length>0||t.mainUrl?`\n                            <select class="resolution-select" id="resolutionSelect">\n                                ${a}\n                            </select>\n                        `:""}\n                    </div>\n                </div>\n                \n                <div class="controls-center">\n                    <button class="control-btn-large" id="prevBtn">\n                        <i class="fas fa-backward"></i>\n                        <span>10s</span>\n                    </button>\n                    \n                    <button class="play-btn" id="playBtn">\n                        <i class="fas fa-play"></i>\n                    </button>\n                    \n                    <button class="control-btn-large" id="nextBtn">\n                        <i class="fas fa-forward"></i>\n                        <span>10s</span>\n                    </button>\n                </div>\n                \n                <div class="controls-bottom">\n                    <div class="progress-container">\n                        <div class="progress-bar-bg">\n                            <div class="progress-buffered" id="progressBuffered"></div>\n                            <div class="progress-current" id="progressCurrent"></div>\n                        </div>\n                        <input \n                            type="range" \n                            id="progressSlider" \n                            class="progress-slider" \n                            min="0" \n                            max="100" \n                            value="0"\n                            step="0.1"\n                        >\n                    </div>\n                    <div class="video-time" id="videoTime">0:00 / 0:00</div>\n                    \n                    <div class="controls-right">\n                        <div class="volume-container">\n                            <button class="control-btn volume-btn" id="volumeBtn">\n                                <i class="fas fa-volume-up"></i>\n                            </button>\n                            <div class="volume-slider-container">\n                                <input \n                                    type="range" \n                                    id="volumeSlider" \n                                    class="volume-slider" \n                                    min="0" \n                                    max="100" \n                                    value="80"\n                                >\n                            </div>\n                        </div>\n                        <button class="control-btn fullscreen-btn" id="fullscreenBtn">\n                            <i class="fas fa-expand"></i>\n                        </button>\n                    </div>\n                </div>\n            </div>\n            \n            <div class="player-error" id="playerError" style="display: none;">\n                <div class="error-icon"><i class="fas fa-exclamation-triangle"></i></div>\n                <div class="error-message">Gagal memuat video</div>\n                <button class="retry-btn" id="retryBtn">Coba Lagi</button>\n            </div>\n        </div>\n    `}function buildLitePlayerHTML(e,t){const n=t.sources||[];let a="";if(n.length>0&&n.forEach(e=>{const t=e.resolution===PlayerState.currentResolution;a+=`<option value="${e.resolution}" ${t?"selected":""}>${e.label}</option>`}),t.mainUrl){const e="auto"===PlayerState.currentResolution;a=`<option value="auto" ${e?"selected":""}>Auto</option>`+a}return`\n        <div class="video-player-wrapper lite">\n            <video \n                id="videoPlayer" \n                class="video-player" \n                controls \n                playsinline \n                webkit-playsinline\n                preload="auto"\n            >\n                Your browser does not support the video tag.\n            </video>\n            \n            <div class="lite-controls">\n                <button class="lite-btn back-btn" id="playerBackBtn">\n                    <i class="fas fa-arrow-left"></i>\n                </button>\n                \n                <div class="episode-info">\n                    <div class="episode-title">${escapeHTML(e)}</div>\n                        \n                    ${n.length>0||t.mainUrl?`\n                        <select class="lite-select" id="resolutionSelect">\n                            ${a}\n                        </select>\n                    `:""}\n                </div>\n            </div>\n            \n            <div class="lite-loading" id="liteLoading">\n                <div class="loading-spinner"></div>\n            </div>\n        </div>\n    `}function initializePlayerElements(){const e=document.getElementById("videoPlayer");if(!e)return;const t=localStorage.getItem("playerVolume");null!==t&&(e.volume=parseFloat(t));const n=document.getElementById("volumeSlider");n&&(n.value=100*e.volume)}function loadVideo(){const e=document.getElementById("videoPlayer"),t=document.getElementById("playerLoading")||document.getElementById("liteLoading");if(!e)return;t&&(t.style.display="flex");const n=document.getElementById("resolutionSelect");let a=null;if(n){const e=n.value;PlayerState.currentResolution=e,a="auto"===e&&PlayerState.sources.mainUrl?PlayerState.sources.mainUrl:PlayerState.sources.sources?.find(t=>t.resolution===e)?.url}else PlayerState.sources.mainUrl?(a=PlayerState.sources.mainUrl,PlayerState.currentResolution="auto"):PlayerState.sources.sources?.[0]?.url&&(a=PlayerState.sources.sources[0].url,PlayerState.currentResolution=PlayerState.sources.sources[0].resolution);if(!a)return void showPlayerError("Tidak ada sumber video tersedia");e.src&&e.src!==a&&(PlayerState.wasPlayingBeforeSwitch=!e.paused,PlayerState.currentTime=e.currentTime),e.src=a,e.load();const i=()=>{e.currentTime=PlayerState.currentTime,(PlayerState.wasPlayingBeforeSwitch||PlayerState.isPlaying)&&e.play().catch(e=>{PlayerState.isPlaying=!1,updatePlayButton()}),e.removeEventListener("loadeddata",i)};if(e.addEventListener("loadeddata",i),!PlayerState.wasPlayingBeforeSwitch){const t=e.play();void 0!==t&&t.catch(e=>{PlayerState.isPlaying=!1,updatePlayButton()})}}function setupPlayerEventListeners(){const e=document.getElementById("videoPlayer"),t=document.getElementById("playBtn"),n=document.getElementById("playerBackBtn"),a=document.getElementById("resolutionSelect"),i=document.getElementById("fullscreenBtn"),o=document.getElementById("prevBtn"),s=document.getElementById("nextBtn"),r=document.getElementById("progressSlider"),d=document.getElementById("volumeBtn"),l=document.getElementById("volumeSlider"),c=document.getElementById("retryBtn");if(!e)return;e.addEventListener("loadeddata",handleVideoLoaded),e.addEventListener("canplay",handleVideoCanPlay),e.addEventListener("playing",handleVideoPlaying),e.addEventListener("pause",handleVideoPause),e.addEventListener("timeupdate",handleTimeUpdate),e.addEventListener("durationchange",handleDurationChange),e.addEventListener("progress",handleBuffering),e.addEventListener("ended",handleVideoEnded),e.addEventListener("error",handleVideoError),e.addEventListener("waiting",handleVideoWaiting),e.addEventListener("seeking",handleVideoSeeking),e.addEventListener("seeked",handleVideoSeeked),t?t.addEventListener("click",togglePlayPause):e.addEventListener("click",togglePlayPause),n&&n.addEventListener("click",closePlayer),a&&a.addEventListener("change",handleResolutionChange),i&&i.addEventListener("click",toggleFullscreen),o&&o.addEventListener("click",()=>seekRelative(-10)),s&&s.addEventListener("click",()=>seekRelative(10)),r&&(r.addEventListener("input",handleProgressInput),r.addEventListener("change",handleProgressChange)),d&&d.addEventListener("click",toggleMute),l&&l.addEventListener("input",handleVolumeChange),c&&c.addEventListener("click",retryLoadVideo),document.addEventListener("keydown",handleKeyboardShortcuts);const u=document.getElementById("videoContainer");if(u){let m;function p(){const e=document.getElementById("videoControls");e&&(e.classList.add("visible"),clearTimeout(m),m=setTimeout(()=>{PlayerState.isLoading||e.classList.remove("visible")},3e3))}u.addEventListener("mousemove",p),u.addEventListener("touchstart",p)}}function handleVideoLoaded(){PlayerState.isLoading=!1;const e=document.getElementById("playerLoading")||document.getElementById("liteLoading");e&&(e.style.display="none");const t=document.getElementById("playerError");t&&(t.style.display="none")}function handleVideoCanPlay(){PlayerState.isLoading=!1;const e=document.getElementById("playerLoading")||document.getElementById("liteLoading");e&&(e.style.display="none"),updateTimeDisplay()}function handleVideoPlaying(){PlayerState.isPlaying=!0,PlayerState.isLoading=!1,updatePlayButton();const e=document.getElementById("playerLoading")||document.getElementById("liteLoading");e&&(e.style.display="none")}function handleVideoPause(){PlayerState.isPlaying=!1,updatePlayButton()}function handleTimeUpdate(){const e=document.getElementById("videoPlayer");e&&(PlayerState.currentTime=e.currentTime,updateProgress(),updateTimeDisplay())}function handleDurationChange(){updateTimeDisplay()}function handleBuffering(){const e=document.getElementById("videoPlayer");if(!e)return;const t=document.getElementById("progressBuffered");if(t&&e.duration>0&&e.buffered.length>0){const n=e.buffered.end(e.buffered.length-1)/e.duration*100;t.style.width=`${n}%`}}function handleVideoEnded(){PlayerState.isPlaying=!1,updatePlayButton();const e=PlayerState.currentEpisodeIndex+1;e<(window.AppState?.currentDrama?.episodes?.length||0)&&showNextEpisodeConfirmation(e)}function showNextEpisodeConfirmation(e){const t=document.getElementById("videoContainer");if(!t)return;const n=window.AppState.currentDrama.episodes[e],a=n.video_title||`Episode ${n.vid_index||e+1}`,i=document.createElement("div");i.className="next-episode-confirmation",i.innerHTML=`\n        <div class="confirmation-content">\n            <div class="confirmation-title">Episode Berikutnya</div>\n            <div class="confirmation-text">${escapeHTML(a)}</div>\n            <div class="confirmation-timer" id="countdownTimer">5</div>\n            <div class="confirmation-buttons">\n                <button class="confirmation-btn cancel-btn" id="cancelNextBtn">Batalkan</button>\n                <button class="confirmation-btn playnext-btn" id="playNextBtn">Putar Sekarang</button>\n            </div>\n        </div>\n    `,t.appendChild(i);let o,s=5;o=setInterval(()=>{s--,(()=>{const e=document.getElementById("countdownTimer");e&&(e.textContent=s)})(),s<=0&&(clearInterval(o),playNextEpisode(e))},1e3),document.getElementById("playNextBtn")?.addEventListener("click",()=>{clearInterval(o),playNextEpisode(e)}),document.getElementById("cancelNextBtn")?.addEventListener("click",()=>{clearInterval(o),i.remove()})}function playNextEpisode(e){const t=document.querySelector(".next-episode-confirmation");t&&t.remove(),window.dispatchEvent(new CustomEvent("app-event",{detail:{event:"episode-click",data:e}}))}function handleVideoError(e){PlayerState.isLoading=!1,showPlayerError("Gagal memuat video. Coba resolusi lain.");const t=document.getElementById("playerLoading")||document.getElementById("liteLoading");t&&(t.style.display="none")}function handleVideoWaiting(){PlayerState.isLoading=!0;const e=document.getElementById("playerLoading")||document.getElementById("liteLoading");e&&(e.style.display="flex")}function handleVideoSeeking(){PlayerState.isLoading=!0}function handleVideoSeeked(){PlayerState.isLoading=!1;const e=document.getElementById("playerLoading")||document.getElementById("liteLoading");e&&(e.style.display="none")}function togglePlayPause(){const e=document.getElementById("videoPlayer");e&&(e.paused||e.ended?e.play().catch(e=>{const t=document.getElementById("playBtn");t&&(t.innerHTML='<i class="fas fa-play"></i>')}):e.pause())}function handleResolutionChange(e){const t=e.target.value,n=document.getElementById("videoPlayer");if(!n)return;PlayerState.currentTime=n.currentTime,PlayerState.wasPlayingBeforeSwitch=!n.paused,PlayerState.currentResolution=t;const a=document.getElementById("playerLoading")||document.getElementById("liteLoading");a&&(a.style.display="flex");let i=null;if(i="auto"===t&&PlayerState.sources.mainUrl?PlayerState.sources.mainUrl:PlayerState.sources.sources?.find(e=>e.resolution===t)?.url,!i)return;n.src=i,n.load();const o=()=>{n.currentTime=PlayerState.currentTime,PlayerState.wasPlayingBeforeSwitch&&n.play().catch(e=>{PlayerState.isPlaying=!1,updatePlayButton()}),a&&(a.style.display="none"),n.removeEventListener("loadeddata",o)};n.addEventListener("loadeddata",o)}function toggleFullscreen(){const e=document.getElementById("videoContainer");e&&(document.fullscreenElement?document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.msExitFullscreen&&document.msExitFullscreen():e.requestFullscreen?e.requestFullscreen():e.webkitRequestFullscreen?e.webkitRequestFullscreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.msRequestFullscreen&&e.msRequestFullscreen())}function handleFullscreenChange(){const e=document.getElementById("fullscreenBtn");e&&(document.fullscreenElement?e.innerHTML='<i class="fas fa-compress"></i>':e.innerHTML='<i class="fas fa-expand"></i>')}function seekRelative(e){const t=document.getElementById("videoPlayer");if(!t)return;const n=t.currentTime+e;t.currentTime=Math.max(0,Math.min(n,t.duration||1/0))}function handleProgressInput(e){if(!document.getElementById("videoPlayer"))return;const t=parseFloat(e.target.value),n=document.getElementById("progressCurrent");n&&(n.style.width=`${t}%`)}function handleProgressChange(e){const t=document.getElementById("videoPlayer");if(!t||!t.duration)return;const n=parseFloat(e.target.value)/100*t.duration;t.currentTime=n}function toggleMute(){const e=document.getElementById("videoPlayer"),t=document.getElementById("volumeBtn");e&&t&&(e.muted=!e.muted,t.innerHTML=e.muted?'<i class="fas fa-volume-mute"></i>':'<i class="fas fa-volume-up"></i>')}function handleVolumeChange(e){const t=document.getElementById("videoPlayer"),n=document.getElementById("volumeBtn");if(!t||!n)return;const a=parseInt(e.target.value)/100;t.volume=a,t.muted=0===a,localStorage.setItem("playerVolume",a.toString()),n.innerHTML=0===a?'<i class="fas fa-volume-mute"></i>':'<i class="fas fa-volume-up"></i>'}function retryLoadVideo(){const e=document.getElementById("playerError");e&&(e.style.display="none"),loadVideo()}function handleKeyboardShortcuts(e){if(document.getElementById("videoPlayer")&&"INPUT"!==e.target.tagName&&"TEXTAREA"!==e.target.tagName)switch(e.key.toLowerCase()){case" ":case"k":e.preventDefault(),togglePlayPause();break;case"f":e.preventDefault(),toggleFullscreen();break;case"m":e.preventDefault(),toggleMute();break;case"arrowleft":e.preventDefault(),seekRelative(-5);break;case"arrowright":e.preventDefault(),seekRelative(5);break;case"arrowup":e.preventDefault(),adjustVolume(.1);break;case"arrowdown":e.preventDefault(),adjustVolume(-.1);break;case"escape":document.fullscreenElement&&toggleFullscreen()}}function updatePlayButton(){const e=document.getElementById("playBtn");e&&(e.innerHTML=PlayerState.isPlaying?'<i class="fas fa-pause"></i>':'<i class="fas fa-play"></i>')}function updateProgress(){const e=document.getElementById("videoPlayer"),t=document.getElementById("progressSlider"),n=document.getElementById("progressCurrent");if(!e||!e.duration)return;const a=PlayerState.currentTime/e.duration*100;t&&(t.value=a),n&&(n.style.width=`${a}%`)}function updateTimeDisplay(){const e=document.getElementById("videoPlayer"),t=document.getElementById("videoTime");if(!e||!t)return;const n=formatTime(PlayerState.currentTime),a=formatTime(e.duration||0);t.textContent=`${n} / ${a}`}function showPlayerError(e){const t=document.getElementById("playerError");if(t){const n=t.querySelector(".error-message");n&&(n.textContent=e),t.style.display="flex"}}function adjustVolume(e){const t=document.getElementById("videoPlayer"),n=document.getElementById("volumeSlider");if(!t||!n)return;let a=t.volume+e;a=Math.max(0,Math.min(1,a)),t.volume=a,n.value=100*a,localStorage.setItem("playerVolume",a.toString())}function formatTime(e){if(!e||isNaN(e))return"0:00";const t=Math.floor(e/3600),n=Math.floor(e%3600/60),a=Math.floor(e%60);return t>0?`${t}:${n.toString().padStart(2,"0")}:${a.toString().padStart(2,"0")}`:`${n}:${a.toString().padStart(2,"0")}`}function escapeHTML(e){if(!e)return"";const t=document.createElement("div");return t.textContent=e,t.innerHTML}function closePlayer(){const e=document.getElementById("videoContainer");if(!e)return;const t=document.getElementById("videoPlayer");t&&(PlayerState.currentTime=t.currentTime,t.pause(),t.src="",t.load()),document.fullscreenElement&&document.exitFullscreen(),e.style.display="none",e.innerHTML="",document.body.style.overflow="",document.removeEventListener("keydown",handleKeyboardShortcuts),PlayerState.currentEpisode=null,PlayerState.sources=null,PlayerState.isPlaying=!1,PlayerState.isLoading=!1,PlayerState.wasPlayingBeforeSwitch=!1,updatePlayingEpisode(-1)}function updatePlayingEpisode(e){if(document.querySelectorAll(".episode-item, .episode-item-lite").forEach(e=>{e.classList.remove("playing")}),e>=0){const t=document.querySelector(`[data-episode-index="${e}"]`);t&&(t.classList.add("playing"),t.scrollIntoView({behavior:"smooth",block:"nearest"}))}}function detectLiteMode(){const e=navigator.deviceMemory&&navigator.deviceMemory<=3,t=/Android [5-8]/i.test(navigator.userAgent),n=window.innerWidth<=360,a=e||t||n;return a&&document.documentElement.classList.add("lite"),a}function setupEventListeners(e){const t=document.getElementById("searchInput"),n=document.getElementById("searchBtn");t&&n&&(n.addEventListener("click",()=>{const e=t.value.trim();e&&window.dispatchEvent(new CustomEvent("app-event",{detail:{event:"search",data:e}}))}),t.addEventListener("keypress",e=>{if("Enter"===e.key){const e=t.value.trim();e&&window.dispatchEvent(new CustomEvent("app-event",{detail:{event:"search",data:e}}))}}),t.addEventListener("focus",()=>{t.select()})),document.querySelectorAll(".category-btn").forEach(e=>{e.addEventListener("click",()=>{const t=e.getAttribute("data-category");t&&window.dispatchEvent(new CustomEvent("app-event",{detail:{event:"category-click",data:t}}))})}),document.querySelectorAll(".nav-btn").forEach(e=>{e.addEventListener("click",()=>{const t=e.getAttribute("data-nav");t&&window.dispatchEvent(new CustomEvent("app-event",{detail:{event:"nav-click",data:t}}))})}),window.addEventListener("app-event",t=>{e&&t.detail&&e(t.detail.event,t.detail.data)}),window.addEventListener("popstate",()=>{window.dispatchEvent(new CustomEvent("app-event",{detail:{event:"nav-click",data:"back"}}))}),document.addEventListener("keydown",e=>{if("Escape"===e.key){const e=document.getElementById("videoContainer");e&&"block"===e.style.display&&window.dispatchEvent(new CustomEvent("app-event",{detail:{event:"player-close"}}))}if(" "===e.key&&!e.target.matches("input, textarea, select")){const t=document.getElementById("videoPlayer");t&&(e.preventDefault(),t.paused?t.play():t.pause())}if("ArrowLeft"===e.key||"ArrowRight"===e.key){const t=document.getElementById("videoPlayer");if(t){e.preventDefault();const n="ArrowLeft"===e.key?-10:10;t.currentTime=Math.max(0,Math.min(t.duration,t.currentTime+n))}}}),window.addEventListener("resize",()=>{handleResponsive()}),handleResponsive()}function handleResponsive(){const e=window.innerWidth,t=document.getElementById("app");e<=480?(t.classList.add("mobile"),t.classList.remove("tablet","desktop")):e<=768?(t.classList.add("tablet"),t.classList.remove("mobile","desktop")):(t.classList.add("desktop"),t.classList.remove("mobile","tablet"))}function updateUI(){document.querySelectorAll(".category-btn").forEach(e=>{e.getAttribute("data-category")===window.AppState?.currentCategory?e.classList.add("active"):e.classList.remove("active")}),document.querySelectorAll(".nav-btn").forEach(e=>{const t=e.getAttribute("data-nav");"home"===t&&"home"===window.AppState?.currentPage?e.classList.add("active"):"back"===t&&window.AppState?.history.length>0?e.classList.remove("disabled"):e.classList.remove("active")});const e=document.getElementById("searchInput");e&&window.AppState?.searchQuery&&(e.value=window.AppState.searchQuery)}function navigate(e){if("back"===e)if(window.AppState?.history.length>1){window.AppState.history.pop();const e=window.AppState.history[window.AppState.history.length-1];if("search"===e.page)if(window.AppState.searchResults.results&&window.AppState.searchResults.results.length>0){renderSearchResults(window.AppState.searchResults,e.query),window.AppState.currentPage="search",window.AppState.searchQuery=e.query;const t=document.getElementById("searchInput");t&&(t.value=e.query)}else window.dispatchEvent(new CustomEvent("app-event",{detail:{event:"search",data:e.query}}));else"home"===e.page?window.dispatchEvent(new CustomEvent("app-event",{detail:{event:"category-click",data:window.AppState.currentCategory||"latest"}})):"detail"===e.page&&window.dispatchEvent(new CustomEvent("app-event",{detail:{event:"drama-click",data:e.dramaId}}))}else window.dispatchEvent(new CustomEvent("app-event",{detail:{event:"category-click",data:"latest"}}));else"home"===e&&(window.AppState.history=[{page:"home"}],window.dispatchEvent(new CustomEvent("app-event",{detail:{event:"category-click",data:"latest"}})));updateUI()}function toggleLiteMode(){const e=document.documentElement.classList.toggle("lite");window.AppState.isLiteMode=e,localStorage.setItem("liteMode",e),"detail"===window.AppState.currentPage&&window.AppState.currentDrama?window.dispatchEvent(new CustomEvent("app-event",{detail:{event:"drama-click",data:window.AppState.currentDrama.id}})):window.dispatchEvent(new CustomEvent("app-event",{detail:{event:"category-click",data:window.AppState.currentCategory}}))}function showNotification(e,t="info",n=3e3){const a=document.querySelector(".notification");a&&a.remove();const i=document.createElement("div");i.className=`notification ${t}`,i.innerHTML=`\n        <div class="notification-content">\n            <i class="fas fa-${"error"===t?"exclamation-circle":"check-circle"}"></i>\n            <span>${e}</span>\n        </div>\n    `,document.body.appendChild(i),setTimeout(()=>{i.classList.add("show")},10),setTimeout(()=>{i.classList.remove("show"),setTimeout(()=>{i.parentNode&&i.parentNode.removeChild(i)},300)},n)}function confirmDialog(e,t){const n=document.querySelector(".confirm-dialog");n&&n.remove();const a=document.createElement("div");a.className="confirm-dialog",a.innerHTML=`\n        <div class="dialog-overlay"></div>\n        <div class="dialog-content">\n            <div class="dialog-message">${e}</div>\n            <div class="dialog-buttons">\n                <button class="dialog-btn cancel">Batal</button>\n                <button class="dialog-btn confirm">OK</button>\n            </div>\n        </div>\n    `,document.body.appendChild(a),a.querySelector(".cancel").addEventListener("click",()=>{a.remove()}),a.querySelector(".confirm").addEventListener("click",()=>{a.remove(),t&&t(!0)}),a.querySelector(".dialog-overlay").addEventListener("click",()=>{a.remove()})}function showLoadingOverlay(e="Memuat..."){const t=document.querySelector(".loading-overlay");t&&t.remove();const n=document.createElement("div");return n.className="loading-overlay",n.innerHTML=`\n        <div class="loading-content">\n            <div class="loading-spinner"></div>\n            <div class="loading-text">${e}</div>\n        </div>\n    `,document.body.appendChild(n),()=>{n.parentNode&&n.parentNode.removeChild(n)}}window.player={openPlayer:openPlayer,closePlayer:closePlayer,getState:()=>PlayerState},window.uiUtils={toggleLiteMode:toggleLiteMode,showNotification:showNotification,confirmDialog:confirmDialog};import{loadLatestDramas,loadTrendingDramas,searchDramas,loadDramaDetail,loadVideoSources}from"./api.js";import{renderGrid,renderDetail,renderSearchResults,renderLoading,renderError}from"./components.js";import{initVideoPlayer,openPlayer,closePlayer}from"./player.js";import{detectLiteMode,setupEventListeners,navigate,updateUI}from"./ui.js";const AppState={currentPage:"home",currentCategory:"latest",currentDrama:null,searchQuery:"",searchResults:[],history:[],isLiteMode:!1,loading:!1};function initApp(){AppState.isLiteMode=detectLiteMode(),AppState.isLiteMode&&document.documentElement.classList.add("lite"),setupEventListeners(handleAppEvent),initVideoPlayer(),loadInitialContent()}function handleAppEvent(e,t){switch(e){case"category-click":handleCategoryClick(t);break;case"search":handleSearch(t);break;case"drama-click":handleDramaClick(t);break;case"episode-click":handleEpisodeClick(t);break;case"nav-click":handleNavClick(t);break;case"player-close":closePlayer();break;case"player-next":handleNextEpisode();break;case"player-prev":handlePrevEpisode()}}async function handleCategoryClick(e){if(!AppState.loading){AppState.currentCategory=e,AppState.currentPage="home",AppState.history.push({page:"home",category:e,timestamp:Date.now()}),updateUI(),renderLoading();try{let t;t="trending"===e?await loadTrendingDramas():await loadLatestDramas(),renderGrid(t,e)}catch(e){renderError("Gagal memuat drama")}}}async function handleSearch(e){if(e.trim()){AppState.searchQuery=e,AppState.currentPage="search",AppState.history.push({page:"search",query:e,timestamp:Date.now()}),AppState.searchResults={results:[],hasMore:!1,total:0},renderLoading("Mencari...");try{const t=await searchDramas(e);AppState.searchResults=t,renderSearchResults(t,e)}catch(e){console.error("Search error:",e),renderError("Pencarian gagal")}}}async function handleDramaClick(e){if(!AppState.loading){AppState.currentPage="detail",AppState.history.push({page:"detail",dramaId:e,previousPage:AppState.currentPage,previousQuery:AppState.searchQuery}),renderLoading("Memuat detail...");try{const t=await loadDramaDetail(e);AppState.currentDrama=t,renderDetail(t)}catch(e){renderError("Gagal memuat detail")}}}async function handleEpisodeClick(e){if(!AppState.currentDrama)return;const t=AppState.currentDrama.episodes[e];if(t)try{const n=await loadVideoSources(t.vid);openPlayer(t,n,e)}catch(e){alert("Gagal memutar video")}}function handleNavClick(e){switch(e){case"home":navigate("home");break;case"back":navigate("back");break;case"search":document.getElementById("searchInput").focus()}}function handleNextEpisode(){if(!AppState.currentDrama)return;const e=(window.currentEpisodeIndex||0)+1;e<AppState.currentDrama.episodes.length&&handleEpisodeClick(e)}function handlePrevEpisode(){if(!AppState.currentDrama)return;const e=(window.currentEpisodeIndex||0)-1;e>=0&&handleEpisodeClick(e)}async function loadInitialContent(){renderLoading();try{const e=await loadLatestDramas();renderGrid(e,"latest")}catch(e){renderError("Gagal memuat konten awal")}}window.AppState=AppState,"loading"===document.readyState?document.addEventListener("DOMContentLoaded",initApp):initApp();